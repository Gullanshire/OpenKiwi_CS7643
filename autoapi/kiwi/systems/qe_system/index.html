

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kiwi.systems.qe_system &#8212; openkiwi 2.0.0 documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/openkiwi-logo-icon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="kiwi.systems.tlm_system" href="../tlm_system/index.html" />
    <link rel="prev" title="kiwi.systems.predictor_estimator" href="../predictor_estimator/index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../../../../index.html">
      <img src="../../../../_static/openkiwi-logo-horizontal.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../installation.html">Installation</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../usage.html">Usage</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../configuration/index.html">Configuration</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../../../systems/index.html">Systems</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../../../index.html">API Reference</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">

<form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
      
      
      
      
      
      
        
          
              <li class="active">
                  <a href="../../index.html">kiwi</a>
              </li>
          
        
      
      
    </ul>

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#module-contents" class="nav-link">Module Contents</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#classes" class="nav-link">Classes</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h4">
            <a href="#kiwi.systems.qe_system.logger" class="nav-link">logger</a>
        </li>
    
        <li class="nav-item toc-entry toc-h4">
            <a href="#kiwi.systems.qe_system.BatchSizeConfig" class="nav-link">BatchSizeConfig</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.BatchSizeConfig.train" class="nav-link">train</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.BatchSizeConfig.valid" class="nav-link">valid</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.BatchSizeConfig.test" class="nav-link">test</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h4">
            <a href="#kiwi.systems.qe_system.ModelConfig" class="nav-link">ModelConfig</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.ModelConfig.encoder" class="nav-link">encoder</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.ModelConfig.decoder" class="nav-link">decoder</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.ModelConfig.outputs" class="nav-link">outputs</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.ModelConfig.tlm_outputs" class="nav-link">tlm_outputs</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h4">
            <a href="#kiwi.systems.qe_system.QESystem" class="nav-link">QESystem</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.Config" class="nav-link">Config</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.class_name" class="nav-link">class_name</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.load" class="nav-link">load</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.load_encoder" class="nav-link">load_encoder</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.load_vocabs" class="nav-link">load_vocabs</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.model" class="nav-link">model</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.data_processing" class="nav-link">data_processing</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.optimizer" class="nav-link">optimizer</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.batch_size" class="nav-link">batch_size</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.num_data_workers" class="nav-link">num_data_workers</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.map_name_to_class" class="nav-link">map_name_to_class</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.check_consistency" class="nav-link">check_consistency</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.check_model_requirement" class="nav-link">check_model_requirement</a>
        </li>
    
        <li class="nav-item toc-entry toc-h6">
            <a href="#kiwi.systems.qe_system.QESystem.Config.check_batching" class="nav-link">check_batching</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.subclasses" class="nav-link">subclasses</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem._load_encoder" class="nav-link">_load_encoder</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.set_config_options" class="nav-link">set_config_options</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.prepare_data" class="nav-link">prepare_data</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.train_dataloader" class="nav-link">train_dataloader</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.val_dataloader" class="nav-link">val_dataloader</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.test_dataloader" class="nav-link">test_dataloader</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.prepare_dataloader" class="nav-link">prepare_dataloader</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.forward" class="nav-link">forward</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.training_step" class="nav-link">training_step</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.training_epoch_end" class="nav-link">training_epoch_end</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.validation_step" class="nav-link">validation_step</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.validation_epoch_end" class="nav-link">validation_epoch_end</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.test_step" class="nav-link">test_step</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.test_epoch_end" class="nav-link">test_epoch_end</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.loss" class="nav-link">loss</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.metrics_step" class="nav-link">metrics_step</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.metrics_end" class="nav-link">metrics_end</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.main_metric" class="nav-link">main_metric</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.num_parameters" class="nav-link">num_parameters</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.from_config" class="nav-link">from_config</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.load" class="nav-link">load</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.from_dict" class="nav-link">from_dict</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem._load_dict" class="nav-link">_load_dict</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.to_dict" class="nav-link">to_dict</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.on_save_checkpoint" class="nav-link">on_save_checkpoint</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.on_load_checkpoint" class="nav-link">on_load_checkpoint</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.load_from_checkpoint" class="nav-link">load_from_checkpoint</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.configure_optimizers" class="nav-link">configure_optimizers</a>
        </li>
    
        <li class="nav-item toc-entry toc-h5">
            <a href="#kiwi.systems.qe_system.QESystem.predict" class="nav-link">predict</a>
        </li>
    
            </ul>
        </li>
    
            </ul>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="module-kiwi.systems.qe_system">
<span id="kiwi-systems-qe-system"></span><h1><a class="reference internal" href="#module-kiwi.systems.qe_system" title="kiwi.systems.qe_system"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kiwi.systems.qe_system</span></code></a><a class="headerlink" href="#module-kiwi.systems.qe_system" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-contents">
<h2>Module Contents<a class="headerlink" href="#module-contents" title="Permalink to this headline">¶</a></h2>
<div class="section" id="classes">
<h3>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h3>
<table class="longtable table">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#kiwi.systems.qe_system.BatchSizeConfig" title="kiwi.systems.qe_system.BatchSizeConfig"><code class="xref py py-obj docutils literal notranslate"><span class="pre">BatchSizeConfig</span></code></a></p></td>
<td><p>Base class for all pydantic configs. Used to configure base behaviour of configs.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#kiwi.systems.qe_system.ModelConfig" title="kiwi.systems.qe_system.ModelConfig"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ModelConfig</span></code></a></p></td>
<td><p>Base class for all pydantic configs. Used to configure base behaviour of configs.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#kiwi.systems.qe_system.QESystem" title="kiwi.systems.qe_system.QESystem"><code class="xref py py-obj docutils literal notranslate"><span class="pre">QESystem</span></code></a></p></td>
<td><p>Helper class that provides a standard way to create an ABC using</p></td>
</tr>
</tbody>
</table>
<dl class="py data">
<dt id="kiwi.systems.qe_system.logger">
<code class="sig-prename descclassname">kiwi.systems.qe_system.</code><code class="sig-name descname">logger</code><a class="headerlink" href="#kiwi.systems.qe_system.logger" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py class">
<dt id="kiwi.systems.qe_system.BatchSizeConfig">
<em class="property">class </em><code class="sig-prename descclassname">kiwi.systems.qe_system.</code><code class="sig-name descname">BatchSizeConfig</code><a class="headerlink" href="#kiwi.systems.qe_system.BatchSizeConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="../../utils/io/index.html#kiwi.utils.io.BaseConfig" title="kiwi.utils.io.BaseConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">kiwi.utils.io.BaseConfig</span></code></a></p>
<p>Base class for all pydantic configs. Used to configure base behaviour of configs.</p>
<dl class="py attribute">
<dt id="kiwi.systems.qe_system.BatchSizeConfig.train">
<code class="sig-name descname">train</code><em class="property"> :PositiveInt = 1</em><a class="headerlink" href="#kiwi.systems.qe_system.BatchSizeConfig.train" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.BatchSizeConfig.valid">
<code class="sig-name descname">valid</code><em class="property"> :PositiveInt = 1</em><a class="headerlink" href="#kiwi.systems.qe_system.BatchSizeConfig.valid" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.BatchSizeConfig.test">
<code class="sig-name descname">test</code><em class="property"> :PositiveInt = 1</em><a class="headerlink" href="#kiwi.systems.qe_system.BatchSizeConfig.test" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py class">
<dt id="kiwi.systems.qe_system.ModelConfig">
<em class="property">class </em><code class="sig-prename descclassname">kiwi.systems.qe_system.</code><code class="sig-name descname">ModelConfig</code><a class="headerlink" href="#kiwi.systems.qe_system.ModelConfig" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="../../utils/io/index.html#kiwi.utils.io.BaseConfig" title="kiwi.utils.io.BaseConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">kiwi.utils.io.BaseConfig</span></code></a></p>
<p>Base class for all pydantic configs. Used to configure base behaviour of configs.</p>
<dl class="py attribute">
<dt id="kiwi.systems.qe_system.ModelConfig.encoder">
<code class="sig-name descname">encoder</code><em class="property"> :Any</em><a class="headerlink" href="#kiwi.systems.qe_system.ModelConfig.encoder" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.ModelConfig.decoder">
<code class="sig-name descname">decoder</code><em class="property"> :Any</em><a class="headerlink" href="#kiwi.systems.qe_system.ModelConfig.decoder" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.ModelConfig.outputs">
<code class="sig-name descname">outputs</code><em class="property"> :Any</em><a class="headerlink" href="#kiwi.systems.qe_system.ModelConfig.outputs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.ModelConfig.tlm_outputs">
<code class="sig-name descname">tlm_outputs</code><em class="property"> :Any</em><a class="headerlink" href="#kiwi.systems.qe_system.ModelConfig.tlm_outputs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py class">
<dt id="kiwi.systems.qe_system.QESystem">
<em class="property">class </em><code class="sig-prename descclassname">kiwi.systems.qe_system.</code><code class="sig-name descname">QESystem</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">config</span></em>, <em class="sig-param"><span class="n">data_config</span><span class="p">:</span> <span class="n">WMTQEDataset.Config</span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="../_meta_module/index.html#kiwi.systems._meta_module.Serializable" title="kiwi.systems._meta_module.Serializable"><code class="xref py py-class docutils literal notranslate"><span class="pre">kiwi.systems._meta_module.Serializable</span></code></a>, <code class="xref py py-class docutils literal notranslate"><span class="pre">pytorch_lightning.LightningModule</span></code></p>
<p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
<dl class="py class">
<dt id="kiwi.systems.qe_system.QESystem.Config">
<em class="property">class </em><code class="sig-name descname">Config</code><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="../../utils/io/index.html#kiwi.utils.io.BaseConfig" title="kiwi.utils.io.BaseConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">kiwi.utils.io.BaseConfig</span></code></a></p>
<p>System configuration base class.</p>
<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.class_name">
<code class="sig-name descname">class_name</code><em class="property"> :Optional[str]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.class_name" title="Permalink to this definition">¶</a></dt>
<dd><p>System class to use (must be a subclass of <code class="docutils literal notranslate"><span class="pre">QESystem</span></code> and decorated with
<code class="docutils literal notranslate"><span class="pre">&#64;QESystem.register_subclass</span></code>).</p>
</dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.load">
<code class="sig-name descname">load</code><em class="property"> :Optional[Path]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.load" title="Permalink to this definition">¶</a></dt>
<dd><p>Load pretrained Kiwi model.
If set, system architecture and vocabulary parameters are ignored.</p>
</dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.load_encoder">
<code class="sig-name descname">load_encoder</code><em class="property"> :Optional[Path]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.load_encoder" title="Permalink to this definition">¶</a></dt>
<dd><p>Load pretrained encoder (e.g., the Predictor).
If set, encoder architecture and vocabulary parameters are ignored
(for the fields that are part of the encoder).</p>
</dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.load_vocabs">
<code class="sig-name descname">load_vocabs</code><em class="property"> :Optional[Path]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.load_vocabs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.model">
<code class="sig-name descname">model</code><em class="property"> :Optional[Dict]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.model" title="Permalink to this definition">¶</a></dt>
<dd><p>System specific options; they will be dynamically validated and instantiated
depending of the <code class="docutils literal notranslate"><span class="pre">class_name</span></code> or <code class="docutils literal notranslate"><span class="pre">load</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.data_processing">
<code class="sig-name descname">data_processing</code><em class="property"> :Optional[WMTQEDataEncoder.Config]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.data_processing" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.optimizer">
<code class="sig-name descname">optimizer</code><em class="property"> :Optional[optimizers.OptimizerConfig]</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.optimizer" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.batch_size">
<code class="sig-name descname">batch_size</code><em class="property"> :BatchSizeConfig = 1</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.batch_size" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.Config.num_data_workers">
<code class="sig-name descname">num_data_workers</code><em class="property"> :int = 4</em><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.num_data_workers" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.Config.map_name_to_class">
<code class="sig-name descname">map_name_to_class</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">v</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.map_name_to_class" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.Config.check_consistency">
<code class="sig-name descname">check_consistency</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">v</span></em>, <em class="sig-param"><span class="n">values</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.check_consistency" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.Config.check_model_requirement">
<code class="sig-name descname">check_model_requirement</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">v</span></em>, <em class="sig-param"><span class="n">values</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.check_model_requirement" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.Config.check_batching">
<code class="sig-name descname">check_batching</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">v</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.Config.check_batching" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py attribute">
<dt id="kiwi.systems.qe_system.QESystem.subclasses">
<code class="sig-name descname">subclasses</code><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.subclasses" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem._load_encoder">
<code class="sig-name descname">_load_encoder</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">path</span><span class="p">:</span> <span class="n">Path</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem._load_encoder" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.set_config_options">
<code class="sig-name descname">set_config_options</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">optimizer_config</span><span class="p">:</span> <span class="n">optimizers.OptimizerConfig</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">batch_size</span><span class="p">:</span> <span class="n"><a class="reference internal" href="#kiwi.systems.qe_system.BatchSizeConfig" title="kiwi.systems.qe_system.BatchSizeConfig">BatchSizeConfig</a></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">num_data_workers</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">data_config</span><span class="p">:</span> <span class="n">WMTQEDataset.Config</span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.set_config_options" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.prepare_data">
<code class="sig-name descname">prepare_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.prepare_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the data sources the model will use to create the data loaders.</p>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.train_dataloader">
<code class="sig-name descname">train_dataloader</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference external" href="https://pytorch.org/docs/master/data.html#torch.utils.data.DataLoader" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))">torch.utils.data.DataLoader</a><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.train_dataloader" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a PyTorch DataLoader for the training set.</p>
<p>Requires calling <code class="docutils literal notranslate"><span class="pre">prepare_data</span></code> beforehand.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>PyTorch DataLoader</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.val_dataloader">
<code class="sig-name descname">val_dataloader</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference external" href="https://pytorch.org/docs/master/data.html#torch.utils.data.DataLoader" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))">torch.utils.data.DataLoader</a><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.val_dataloader" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a PyTorch DataLoader for the validation set.</p>
<p>Requires calling <code class="docutils literal notranslate"><span class="pre">prepare_data</span></code> beforehand.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>PyTorch DataLoader</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.test_dataloader">
<code class="sig-name descname">test_dataloader</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span> &#x2192; Optional<span class="p">[</span>DataLoader<span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.test_dataloader" title="Permalink to this definition">¶</a></dt>
<dd><p>Implement one or multiple PyTorch DataLoaders for testing.</p>
<p>The dataloader you return will not be called every epoch unless you set
<a href="#id1"><span class="problematic" id="id2">:paramref:`~pytorch_lightning.trainer.Trainer.reload_dataloaders_every_epoch`</span></a> to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>For data processing use the following pattern:</p>
<blockquote>
<div><ul class="simple">
<li><p>download in <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.prepare_data" title="kiwi.systems.qe_system.QESystem.prepare_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">prepare_data()</span></code></a></p></li>
<li><p>process and split in <code class="xref py py-meth docutils literal notranslate"><span class="pre">setup()</span></code></p></li>
</ul>
</div></blockquote>
<p>However, the above are only necessary for distributed processing.</p>
<div class="alert alert-warning">
<p class="admonition-title">Warning</p>
<p>do not assign state in prepare_data</p>
</div>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">fit()</span></code></p></li>
<li><p>…</p></li>
<li><p><a class="reference internal" href="#kiwi.systems.qe_system.QESystem.prepare_data" title="kiwi.systems.qe_system.QESystem.prepare_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">prepare_data()</span></code></a></p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">setup()</span></code></p></li>
<li><p><a class="reference internal" href="#kiwi.systems.qe_system.QESystem.train_dataloader" title="kiwi.systems.qe_system.QESystem.train_dataloader"><code class="xref py py-meth docutils literal notranslate"><span class="pre">train_dataloader()</span></code></a></p></li>
<li><p><a class="reference internal" href="#kiwi.systems.qe_system.QESystem.val_dataloader" title="kiwi.systems.qe_system.QESystem.val_dataloader"><code class="xref py py-meth docutils literal notranslate"><span class="pre">val_dataloader()</span></code></a></p></li>
<li><p><a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_dataloader" title="kiwi.systems.qe_system.QESystem.test_dataloader"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_dataloader()</span></code></a></p></li>
</ul>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Lightning adds the correct sampler for distributed and arbitrary hardware.
There is no need to set it yourself.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>Single or multiple PyTorch DataLoaders.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,),</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,))])</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;/path/to/mnist/&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">loader</span>
</pre></div>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If you don’t need a test dataset and a <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_step" title="kiwi.systems.qe_system.QESystem.test_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step()</span></code></a>, you don’t need to implement
this method.</p>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.prepare_dataloader">
<code class="sig-name descname">prepare_dataloader</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">dataset</span><span class="p">:</span> <span class="n">WMTQEDataset</span></em>, <em class="sig-param"><span class="n">batch_size</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a></span> <span class="o">=</span> <span class="default_value">1</span></em>, <em class="sig-param"><span class="n">num_workers</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a></span> <span class="o">=</span> <span class="default_value">0</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.prepare_dataloader" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.forward">
<code class="sig-name descname">forward</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">batch_inputs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.forward" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as <a class="reference external" href="https://pytorch.org/docs/master/generated/torch.nn.Module.html#torch.nn.Module.forward" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-meth docutils literal notranslate"><span class="pre">torch.nn.Module.forward()</span></code></a>, however in Lightning you want this to define
the operations you want to use for prediction (i.e.: on a server or as a feature extractor).</p>
<p>Normally you’d call <code class="docutils literal notranslate"><span class="pre">self()</span></code> from your <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.training_step" title="kiwi.systems.qe_system.QESystem.training_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">training_step()</span></code></a> method.
This makes it easy to write a complex system for training with the outputs
you’d want in a prediction setting.</p>
<p>You may also find the <code class="xref py py-func docutils literal notranslate"><span class="pre">auto_move_data()</span></code> decorator useful
when using the module outside Lightning in a production setting.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>*args</strong> – Whatever you decide to pass into the forward method.</p></li>
<li><p><strong>**kwargs</strong> – Keyword arguments are also possible.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Predicted output</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># example if we were using this model as a feature extractor</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feature_maps</span>

<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">)</span>

    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="c1"># splitting it this way allows model to be used a feature extractor</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MyModelAbove</span><span class="p">()</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_request</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">write_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># -------------</span>
<span class="c1"># This is in stark contrast to torch.nn.Module where normally you would have this:</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logits</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.training_step">
<code class="sig-name descname">training_step</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">batch</span><span class="p">:</span> <span class="n">MultiFieldBatch</span></em>, <em class="sig-param"><span class="n">batch_idx</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a></span></em><span class="sig-paren">)</span> &#x2192; Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.training_step" title="Permalink to this definition">¶</a></dt>
<dd><p>Here you compute and return the training loss and some additional metrics for e.g.
the progress bar or logger.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>batch</strong> (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a> | (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …) | [<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …]) – The output of your <a class="reference external" href="https://pytorch.org/docs/master/data.html#torch.utils.data.DataLoader" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataLoader</span></code></a>. A tensor, tuple or list.</p></li>
<li><p><strong>batch_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – Integer displaying index of this batch</p></li>
<li><p><strong>optimizer_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – When using multiple optimizers, this argument will also be present.</p></li>
<li><p><strong>hiddens</strong> (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>) – Passed in if
<a href="#id3"><span class="problematic" id="id4">:paramref:`~pytorch_lightning.trainer.trainer.Trainer.truncated_bptt_steps`</span></a> &gt; 0.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>Dict with loss key and optional log or progress bar keys.
When implementing <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.training_step" title="kiwi.systems.qe_system.QESystem.training_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">training_step()</span></code></a>, return whatever you need in that step:</p>
<ul class="simple">
<li><p>loss -&gt; tensor scalar <strong>REQUIRED</strong></p></li>
<li><p>progress_bar -&gt; Dict for progress bar display. Must have only tensors</p></li>
<li><p>log -&gt; Dict of metrics to add to logger. Must have only tensors (no images, etc)</p></li>
</ul>
</p>
</dd>
</dl>
<p>In this step you’d normally do the forward pass and calculate the loss for a batch.
You can also do fancier things like multiple forward passes or something model specific.</p>
<p class="rubric">Examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="c1"># implement your own</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">logger_logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;training_loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span> <span class="c1"># optional (MUST ALL BE TENSORS)</span>

    <span class="c1"># if using TestTubeLogger or TensorBoardLogger you can nest scalars</span>
    <span class="n">logger_logs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;losses&#39;</span><span class="p">:</span> <span class="n">logger_logs</span><span class="p">}</span> <span class="c1"># optional (MUST ALL BE TENSORS)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="c1"># required</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;training_loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">},</span> <span class="c1"># optional (MUST ALL BE TENSORS)</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">logger_logs</span>
    <span class="p">}</span>

    <span class="c1"># return a dict</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>If you define multiple optimizers, this step will be called with an additional
<code class="docutils literal notranslate"><span class="pre">optimizer_idx</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Multiple optimizers (e.g.: GANs)</span>
<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">optimizer_idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># do training_step with encoder</span>
    <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># do training_step with decoder</span>
</pre></div>
</div>
<p>If you add truncated back propagation through time you will also get an additional
argument with the hidden states of the previous step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Truncated back-propagation through time</span>
<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">hiddens</span><span class="p">):</span>
    <span class="c1"># hiddens are the hidden states from the previous truncated backprop step</span>
    <span class="o">...</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">hiddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hiddens</span><span class="p">)</span>
    <span class="o">...</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
        <span class="s2">&quot;hiddens&quot;</span><span class="p">:</span> <span class="n">hiddens</span>  <span class="c1"># remember to detach() this</span>
    <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">Notes</p>
<p>The loss value shown in the progress bar is smoothed (averaged) over the last values,
so it differs from the actual loss returned in train/validation step.</p>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.training_epoch_end">
<code class="sig-name descname">training_epoch_end</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">outputs</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>List<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">, </span>List<span class="p">[</span>List<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">]</span><span class="p">]</span></span></em><span class="sig-paren">)</span> &#x2192; Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Union<span class="p">[</span><a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))">torch.Tensor</a><span class="p">, </span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.training_epoch_end" title="Permalink to this definition">¶</a></dt>
<dd><p>Called at the end of the training epoch with the outputs of all training steps.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the pseudocode for these calls</span>
<span class="n">train_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">train_batch</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">training_step</span><span class="p">(</span><span class="n">train_batch</span><span class="p">)</span>
    <span class="n">train_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">training_epoch_end</span><span class="p">(</span><span class="n">train_outs</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>outputs</strong> – List of outputs you defined in <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.training_step" title="kiwi.systems.qe_system.QESystem.training_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">training_step()</span></code></a>, or if there are
multiple dataloaders, a list containing a list of outputs for each dataloader.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>Dict or OrderedDict.
May contain the following optional keys:</p>
<ul class="simple">
<li><p>log (metrics to be added to the logger; only tensors)</p></li>
<li><p>progress_bar (dict for progress bar display)</p></li>
<li><p>any metric used in a callback (e.g. early stopping).</p></li>
</ul>
</p>
</dd>
</dl>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If this method is not overridden, this won’t be called.</p>
</div>
<ul class="simple">
<li><p>The outputs here are strictly for logging or progress bar.</p></li>
<li><p>If you don’t need to display anything, don’t return anything.</p></li>
<li><p>If you want to manually set current step, you can specify the ‘step’ key in the ‘log’ dict.</p></li>
</ul>
<p class="rubric">Examples</p>
<p>With a single dataloader:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">training_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">train_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">train_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span>

    <span class="n">train_acc_mean</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

    <span class="c1"># log training accuracy at the end of an epoch</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">train_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()},</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">train_acc_mean</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>With multiple dataloaders, <code class="docutils literal notranslate"><span class="pre">outputs</span></code> will be a list of lists. The outer list contains
one entry per dataloader, while the inner list contains the individual outputs of
each training step for that dataloader.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">training_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">train_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dataloader_outputs</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">dataloader_outputs</span><span class="p">:</span>
            <span class="n">train_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">train_acc_mean</span> <span class="o">/=</span> <span class="n">i</span>

    <span class="c1"># log training accuracy at the end of an epoch</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">train_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">}</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">train_acc_mean</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.validation_step">
<code class="sig-name descname">validation_step</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">batch</span></em>, <em class="sig-param"><span class="n">batch_idx</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.validation_step" title="Permalink to this definition">¶</a></dt>
<dd><p>Operates on a single batch of data from the validation set.
In this step you’d might generate examples or calculate anything of interest like accuracy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the pseudocode for these calls</span>
<span class="n">val_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val_batch</span> <span class="ow">in</span> <span class="n">val_data</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">validation_step</span><span class="p">(</span><span class="n">train_batch</span><span class="p">)</span>
    <span class="n">val_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">validation_epoch_end</span><span class="p">(</span><span class="n">val_outs</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>batch</strong> (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a> | (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …) | [<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …]) – The output of your <a class="reference external" href="https://pytorch.org/docs/master/data.html#torch.utils.data.DataLoader" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataLoader</span></code></a>. A tensor, tuple or list.</p></li>
<li><p><strong>batch_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – The index of this batch</p></li>
<li><p><strong>dataloader_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – The index of the dataloader that produced this batch
(only if multiple val datasets used)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Dict or OrderedDict - passed to <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.validation_epoch_end" title="kiwi.systems.qe_system.QESystem.validation_epoch_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">validation_epoch_end()</span></code></a>.
If you defined <code class="xref py py-meth docutils literal notranslate"><span class="pre">validation_step_end()</span></code> it will go to that first.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># pseudocode of order</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">validation_step</span><span class="p">()</span>
<span class="k">if</span> <span class="n">defined</span><span class="p">(</span><span class="s1">&#39;validation_step_end&#39;</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">validation_step_end</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">validation_epoch_end</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you have one val dataloader:</span>
<span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">)</span>

<span class="c1"># if you have multiple val dataloaders:</span>
<span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">Examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CASE 1: A single validation dataset</span>
<span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="c1"># implement your own</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># log 6 example images</span>
    <span class="c1"># or generated text... or whatever</span>
    <span class="n">sample_imgs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_grid</span><span class="p">(</span><span class="n">sample_imgs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="s1">&#39;example_images&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># calculate acc</span>
    <span class="n">labels_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">val_acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">labels_hat</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># all optional...</span>
    <span class="c1"># return whatever you need for the collation function validation_epoch_end</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
        <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="n">loss_val</span><span class="p">,</span>
        <span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">val_acc</span><span class="p">),</span> <span class="c1"># everything must be a tensor</span>
    <span class="p">})</span>

    <span class="c1"># return an optional dict</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>If you pass in multiple val datasets, validation_step will have an additional argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CASE 2: multiple validation datasets</span>
<span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataset_idx</span><span class="p">):</span>
    <span class="c1"># dataset_idx tells you which dataset this is.</span>
</pre></div>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If you don’t need to validate you don’t need to implement this method.</p>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>When the <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.validation_step" title="kiwi.systems.qe_system.QESystem.validation_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">validation_step()</span></code></a> is called, the model has been put in eval mode
and PyTorch gradients have been disabled. At the end of validation,
the model goes back to training mode and gradients are enabled.</p>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.validation_epoch_end">
<code class="sig-name descname">validation_epoch_end</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">outputs</span><span class="p">:</span> <span class="n">List<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">]</span></span></em><span class="sig-paren">)</span> &#x2192; Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.validation_epoch_end" title="Permalink to this definition">¶</a></dt>
<dd><p>Called at the end of the validation epoch with the outputs of all validation steps.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the pseudocode for these calls</span>
<span class="n">val_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val_batch</span> <span class="ow">in</span> <span class="n">val_data</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">validation_step</span><span class="p">(</span><span class="n">val_batch</span><span class="p">)</span>
    <span class="n">val_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">validation_epoch_end</span><span class="p">(</span><span class="n">val_outs</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>outputs</strong> – List of outputs you defined in <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.validation_step" title="kiwi.systems.qe_system.QESystem.validation_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">validation_step()</span></code></a>, or if there
are multiple dataloaders, a list containing a list of outputs for each dataloader.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>Dict or OrderedDict.
May have the following optional keys:</p>
<ul class="simple">
<li><p>progress_bar (dict for progress bar display; only tensors)</p></li>
<li><p>log (dict of metrics to add to logger; only tensors).</p></li>
</ul>
</p>
</dd>
</dl>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If you didn’t define a <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.validation_step" title="kiwi.systems.qe_system.QESystem.validation_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">validation_step()</span></code></a>, this won’t be called.</p>
</div>
<ul class="simple">
<li><p>The outputs here are strictly for logging or progress bar.</p></li>
<li><p>If you don’t need to display anything, don’t return anything.</p></li>
<li><p>If you want to manually set current step, you can specify the ‘step’ key in the ‘log’ dict.</p></li>
</ul>
<p class="rubric">Examples</p>
<p>With a single dataloader:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">val_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">val_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">]</span>

    <span class="n">val_acc_mean</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
    <span class="n">tqdm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">val_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="c1"># show val_acc in progress bar but only log val_loss</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="n">tqdm_dict</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">val_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>With multiple dataloaders, <cite>outputs</cite> will be a list of lists. The outer list contains
one entry per dataloader, while the inner list contains the individual outputs of
each validation step for that dataloader.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">val_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dataloader_outputs</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">dataloader_outputs</span><span class="p">:</span>
            <span class="n">val_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">val_acc_mean</span> <span class="o">/=</span> <span class="n">i</span>
    <span class="n">tqdm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">val_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="c1"># show val_loss and val_acc in progress bar but only log val_loss</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="n">tqdm_dict</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">val_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.test_step">
<code class="sig-name descname">test_step</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span> &#x2192; Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.test_step" title="Permalink to this definition">¶</a></dt>
<dd><p>Operates on a single batch of data from the test set.
In this step you’d normally generate examples or calculate anything of interest
such as accuracy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the pseudocode for these calls</span>
<span class="n">test_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">test_batch</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">test_step</span><span class="p">(</span><span class="n">test_batch</span><span class="p">)</span>
    <span class="n">test_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">test_epoch_end</span><span class="p">(</span><span class="n">test_outs</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>batch</strong> (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a> | (<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …) | [<a class="reference external" href="https://pytorch.org/docs/master/tensors.html#torch.Tensor" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">Tensor</span></code></a>, …]) – The output of your <a class="reference external" href="https://pytorch.org/docs/master/data.html#torch.utils.data.DataLoader" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataLoader</span></code></a>. A tensor, tuple or list.</p></li>
<li><p><strong>batch_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – The index of this batch.</p></li>
<li><p><strong>dataloader_idx</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><em>int</em></a>) – The index of the dataloader that produced this batch
(only if multiple test datasets used).</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Dict or OrderedDict - passed to the <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_epoch_end" title="kiwi.systems.qe_system.QESystem.test_epoch_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_epoch_end()</span></code></a> method.
If you defined <code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step_end()</span></code> it will go to that first.</p>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># if you have one test dataloader:</span>
<span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">)</span>

<span class="c1"># if you have multiple test dataloaders:</span>
<span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">Examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CASE 1: A single test dataset</span>
<span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="c1"># implement your own</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># log 6 example images</span>
    <span class="c1"># or generated text... or whatever</span>
    <span class="n">sample_imgs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_grid</span><span class="p">(</span><span class="n">sample_imgs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="s1">&#39;example_images&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># calculate acc</span>
    <span class="n">labels_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">val_acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">labels_hat</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># all optional...</span>
    <span class="c1"># return whatever you need for the collation function test_epoch_end</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span>
        <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="n">loss_val</span><span class="p">,</span>
        <span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">val_acc</span><span class="p">),</span> <span class="c1"># everything must be a tensor</span>
    <span class="p">})</span>

    <span class="c1"># return an optional dict</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>If you pass in multiple validation datasets, <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_step" title="kiwi.systems.qe_system.QESystem.test_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step()</span></code></a> will have an additional
argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CASE 2: multiple test datasets</span>
<span class="k">def</span> <span class="nf">test_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataset_idx</span><span class="p">):</span>
    <span class="c1"># dataset_idx tells you which dataset this is.</span>
</pre></div>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If you don’t need to validate you don’t need to implement this method.</p>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>When the <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_step" title="kiwi.systems.qe_system.QESystem.test_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step()</span></code></a> is called, the model has been put in eval mode and
PyTorch gradients have been disabled. At the end of the test epoch, the model goes back
to training mode and gradients are enabled.</p>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.test_epoch_end">
<code class="sig-name descname">test_epoch_end</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">outputs</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>List<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">, </span>List<span class="p">[</span>List<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><span class="p">]</span><span class="p">]</span></span></em><span class="sig-paren">)</span> &#x2192; Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Tensor<span class="p">]</span><span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.test_epoch_end" title="Permalink to this definition">¶</a></dt>
<dd><p>Called at the end of a test epoch with the output of all test steps.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># the pseudocode for these calls</span>
<span class="n">test_outs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">test_batch</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">test_step</span><span class="p">(</span><span class="n">test_batch</span><span class="p">)</span>
    <span class="n">test_outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="n">test_epoch_end</span><span class="p">(</span><span class="n">test_outs</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>outputs</strong> – List of outputs you defined in <code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step_end()</span></code>, or if there
are multiple dataloaders, a list containing a list of outputs for each dataloader</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>Dict has the following optional keys:</p>
<ul class="simple">
<li><p>progress_bar -&gt; Dict for progress bar display. Must have only tensors.</p></li>
<li><p>log -&gt; Dict of metrics to add to logger. Must have only tensors (no images, etc).</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>Dict or OrderedDict</p>
</dd>
</dl>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>If you didn’t define a <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.test_step" title="kiwi.systems.qe_system.QESystem.test_step"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_step()</span></code></a>, this won’t be called.</p>
</div>
<ul class="simple">
<li><p>The outputs here are strictly for logging or progress bar.</p></li>
<li><p>If you don’t need to display anything, don’t return anything.</p></li>
<li><p>If you want to manually set current step, specify it with the ‘step’ key in the ‘log’ Dict</p></li>
</ul>
<p class="rubric">Examples</p>
<p>With a single dataloader:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">test_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">test_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;test_acc&#39;</span><span class="p">]</span>

    <span class="n">test_acc_mean</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
    <span class="n">tqdm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="c1"># show test_loss and test_acc in progress bar but only log test_loss</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="n">tqdm_dict</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>With multiple dataloaders, <cite>outputs</cite> will be a list of lists. The outer list contains
one entry per dataloader, while the inner list contains the individual outputs of
each test step for that dataloader.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">test_acc_mean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dataloader_outputs</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">dataloader_outputs</span><span class="p">:</span>
            <span class="n">test_acc_mean</span> <span class="o">+=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;test_acc&#39;</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">test_acc_mean</span> <span class="o">/=</span> <span class="n">i</span>
    <span class="n">tqdm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>

    <span class="c1"># show test_loss and test_acc in progress bar but only log test_loss</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;progress_bar&#39;</span><span class="p">:</span> <span class="n">tqdm_dict</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">test_acc_mean</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.loss">
<code class="sig-name descname">loss</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">model_out</span></em>, <em class="sig-param"><span class="n">batch</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.loss" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.metrics_step">
<code class="sig-name descname">metrics_step</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">batch</span></em>, <em class="sig-param"><span class="n">model_out</span></em>, <em class="sig-param"><span class="n">loss_dict</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.metrics_step" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.metrics_end">
<code class="sig-name descname">metrics_end</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">steps</span></em>, <em class="sig-param"><span class="n">prefix</span><span class="o">=</span><span class="default_value">''</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.metrics_end" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.main_metric">
<code class="sig-name descname">main_metric</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">selected_metric</span><span class="p">:</span> <span class="n">Union<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>List<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.main_metric" title="Permalink to this definition">¶</a></dt>
<dd><p>Configure and retrieve the metric to be used for monitoring.</p>
<p>The first time it is called, the main metric is configured based on the
specified metrics in <code class="docutils literal notranslate"><span class="pre">selected_metric</span></code> or, if not provided, on the first
metric in the outputs. Subsequent calls return the configured main metric.
If a subsequent call specifies <code class="docutils literal notranslate"><span class="pre">selected_metric</span></code>, configuration is done again.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p><dl class="simple">
<dt>a tuple containing the main metric name and the ordering.</dt><dd><p>Note that the first element might be a concatenation of several
metrics in case <code class="docutils literal notranslate"><span class="pre">selected_metric</span></code> is a list. This is useful for
considering more than one metric as the best
(<code class="docutils literal notranslate"><span class="pre">metric_end()</span></code> will sum over them).</p>
</dd>
</dl>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.num_parameters">
<code class="sig-name descname">num_parameters</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.num_parameters" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.from_config">
<em class="property">static </em><code class="sig-name descname">from_config</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">config</span><span class="p">:</span> <span class="n"><a class="reference internal" href="#kiwi.systems.qe_system.QESystem.Config" title="kiwi.systems.qe_system.QESystem.Config">Config</a></span></em>, <em class="sig-param"><span class="n">data_config</span><span class="p">:</span> <span class="n">WMTQEDataset.Config</span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.from_config" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.load">
<em class="property">classmethod </em><code class="sig-name descname">load</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">path</span><span class="p">:</span> <span class="n">Path</span></em>, <em class="sig-param"><span class="n">map_location</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.load" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.from_dict">
<em class="property">classmethod </em><code class="sig-name descname">from_dict</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">module_dict</span><span class="p">:</span> <span class="n">Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>Any<span class="p">]</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.from_dict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem._load_dict">
<code class="sig-name descname">_load_dict</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">module_dict</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem._load_dict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.to_dict">
<code class="sig-name descname">to_dict</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">include_state</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.to_dict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.on_save_checkpoint">
<code class="sig-name descname">on_save_checkpoint</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">checkpoint</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.on_save_checkpoint" title="Permalink to this definition">¶</a></dt>
<dd><p>Called by Lightning when saving a checkpoint to give you a chance to store anything
else you might want to save.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>checkpoint</strong> – Checkpoint to be saved</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
    <span class="c1"># 99% of use cases you don&#39;t need to implement this method</span>
    <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;something_cool_i_want_to_save&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_cool_pickable_object</span>
</pre></div>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Lightning saves all aspects of training (epoch, global step, etc…)
including amp scaling.
There is no need for you to store anything about training.</p>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.on_load_checkpoint">
<code class="sig-name descname">on_load_checkpoint</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">checkpoint</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.on_load_checkpoint" title="Permalink to this definition">¶</a></dt>
<dd><p>Called by Lightning to restore your model.
If you saved something with <a class="reference internal" href="#kiwi.systems.qe_system.QESystem.on_save_checkpoint" title="kiwi.systems.qe_system.QESystem.on_save_checkpoint"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_save_checkpoint()</span></code></a> this is your chance to restore this.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>checkpoint</strong> – Loaded checkpoint</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">on_load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
    <span class="c1"># 99% of the time you don&#39;t need to implement this method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">something_cool_i_want_to_save</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;something_cool_i_want_to_save&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="alert alert-info">
<p class="admonition-title">Note</p>
<p>Lightning auto-restores global step, epoch, and train state including amp scaling.
There is no need for you to restore anything regarding training.</p>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.load_from_checkpoint">
<em class="property">classmethod </em><code class="sig-name descname">load_from_checkpoint</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cls</span></em>, <em class="sig-param"><span class="n">checkpoint_path</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></span></em>, <em class="sig-param"><span class="n">map_location</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>Union<span class="p">[</span>Dict<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">]</span><span class="p">, </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span>torch.device<span class="p">, </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)">int</a><span class="p">, </span>Callable<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">tags_csv</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span> &#x2192; ’pl.LightningModule’<a class="headerlink" href="#kiwi.systems.qe_system.QESystem.load_from_checkpoint" title="Permalink to this definition">¶</a></dt>
<dd><p>Primary way of loading a model from a checkpoint. When Lightning saves a checkpoint
it stores the arguments passed to <cite>__init__</cite>  in the checkpoint under <cite>module_arguments</cite></p>
<p>Any arguments specified through *args and **kwargs will override args stored in <cite>hparams</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>checkpoint_path</strong> – Path to checkpoint. This can also be a URL.</p></li>
<li><p><strong>args</strong> – Any positional args needed to init the model.</p></li>
<li><p><strong>map_location</strong> – If your checkpoint saved a GPU model and you now load on CPUs
or a different number of GPUs, use this to map to the new setup.
The behaviour is the same as in <a class="reference external" href="https://pytorch.org/docs/master/generated/torch.load.html#torch.load" title="(in PyTorch vmaster (1.8.0a0+9bc97fc ))"><code class="xref py py-func docutils literal notranslate"><span class="pre">torch.load()</span></code></a>.</p></li>
<li><p><strong>hparams_file</strong> – <p>Optional path to a .yaml file with hierarchical structure
as in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drop_prob</span><span class="p">:</span> <span class="mf">0.2</span>
<span class="n">dataloader</span><span class="p">:</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="mi">32</span>
</pre></div>
</div>
<p>You most likely won’t need this since Lightning will always save the hyperparameters
to the checkpoint.
However, if your checkpoint weights don’t have the hyperparameters saved,
use this method to pass in a .yaml file with the hparams you’d like to use.
These will be converted into a <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dict</span></code></a> and passed into your
<code class="xref py py-class docutils literal notranslate"><span class="pre">LightningModule</span></code> for use.</p>
<p>If your model’s <cite>hparams</cite> argument is <a class="reference external" href="https://docs.python.org/3/library/argparse.html#argparse.Namespace" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Namespace</span></code></a>
and .yaml file has hierarchical structure, you need to refactor your model to treat
<cite>hparams</cite> as <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dict</span></code></a>.</p>
<p>.csv files are acceptable here till v0.9.0, see tags_csv argument for detailed usage.</p>
</p></li>
<li><p><strong>tags_csv</strong> – <div class="alert alert-warning">
<p class="admonition-title">Warning</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 0.7.6.</span></p>
</div>
<p><cite>tags_csv</cite> argument is deprecated in v0.7.6. Will be removed v0.9.0.</p>
</div>
<p>Optional path to a .csv file with two columns (key, value)
as in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">,</span><span class="n">value</span>
<span class="n">drop_prob</span><span class="p">,</span><span class="mf">0.2</span>
<span class="n">batch_size</span><span class="p">,</span><span class="mi">32</span>
</pre></div>
</div>
<p>Use this method to pass in a .csv file with the hparams you’d like to use.</p>
</p></li>
<li><p><strong>hparam_overrides</strong> – A dictionary with keys to override in the hparams</p></li>
<li><p><strong>kwargs</strong> – Any keyword args needed to init the model.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">LightningModule</span></code> with loaded weights and hyperparameters (if available).</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># load weights without mapping ...</span>
<span class="n">MyLightningModule</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="s1">&#39;path/to/checkpoint.ckpt&#39;</span><span class="p">)</span>

<span class="c1"># or load weights mapping all weights from GPU 1 to GPU 0 ...</span>
<span class="n">map_location</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cuda:1&#39;</span><span class="p">:</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">}</span>
<span class="n">MyLightningModule</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
    <span class="s1">&#39;path/to/checkpoint.ckpt&#39;</span><span class="p">,</span>
    <span class="n">map_location</span><span class="o">=</span><span class="n">map_location</span>
<span class="p">)</span>

<span class="c1"># or load weights and hyperparameters from separate files.</span>
<span class="n">MyLightningModule</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
    <span class="s1">&#39;path/to/checkpoint.ckpt&#39;</span><span class="p">,</span>
    <span class="n">hparams_file</span><span class="o">=</span><span class="s1">&#39;/path/to/hparams_file.yaml&#39;</span>
<span class="p">)</span>

<span class="c1"># override some of the params with new values</span>
<span class="n">MyLightningModule</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
    <span class="n">PATH</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">pretrained_ckpt_path</span><span class="p">:</span> <span class="n">NEW_PATH</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># predict</span>
<span class="n">pretrained_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">pretrained_model</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">pretrained_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.configure_optimizers">
<code class="sig-name descname">configure_optimizers</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em><span class="sig-paren">)</span> &#x2192; Optional<span class="p">[</span>Union<span class="p">[</span>Optimizer<span class="p">, </span>Sequence<span class="p">[</span>Optimizer<span class="p">]</span><span class="p">, </span>Tuple<span class="p">[</span>List<span class="p">, </span>List<span class="p">]</span><span class="p">]</span><span class="p">]</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.configure_optimizers" title="Permalink to this definition">¶</a></dt>
<dd><p>Instantiate configured optimizer and LR scheduler.</p>
<dl class="simple">
<dt>Return: for compatibility with PyTorch-Lightning, any of these 3 options:</dt><dd><ul class="simple">
<li><p>Single optimizer</p></li>
<li><p>List or Tuple - List of optimizers</p></li>
<li><dl class="simple">
<dt>Tuple of Two lists - The first with multiple optimizers, the second with</dt><dd><p>learning-rate schedulers</p>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="kiwi.systems.qe_system.QESystem.predict">
<code class="sig-name descname">predict</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">batch_inputs</span></em>, <em class="sig-param"><span class="n">positive_class_label</span><span class="o">=</span><span class="default_value">const.BAD</span></em><span class="sig-paren">)</span><a class="headerlink" href="#kiwi.systems.qe_system.QESystem.predict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="../predictor_estimator/index.html" title="previous page"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kiwi.systems.predictor_estimator</span></code></a>
    <a class='right-next' id="next-link" href="../tlm_system/index.html" title="next page"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kiwi.systems.tlm_system</span></code></a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../../../../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2019-2020 Unbabel. All rights reserved. Source code available under the AGPL-3.0..<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>